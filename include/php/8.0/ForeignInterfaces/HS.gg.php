<?php namespace Hardstuck\GuildWars2\BuildCodes\V2\Foreign\HS;

use Hardstuck\GuildWars2\BuildCodes\V2\APICache;
use Hardstuck\GuildWars2\BuildCodes\V2\BuildCode;
use Hardstuck\GuildWars2\BuildCodes\V2\ItemId;
use Hardstuck\GuildWars2\BuildCodes\V2\Kind;
use Hardstuck\GuildWars2\BuildCodes\V2\LazyLoadMode;
use Hardstuck\GuildWars2\BuildCodes\V2\PerProfessionData;
use Hardstuck\GuildWars2\BuildCodes\V2\Profession;
use Hardstuck\GuildWars2\BuildCodes\V2\SpecializationId;
use Hardstuck\GuildWars2\BuildCodes\V2\Statics;
use Hardstuck\GuildWars2\BuildCodes\V2\TextLoader;
use Hardstuck\GuildWars2\BuildCodes\V2\TraitSlot;
use Hardstuck\GuildWars2\BuildCodes\V2\Util\AllEquipmentInfusions;
use Hardstuck\GuildWars2\BuildCodes\V2\WeaponSetNumber;
use Hardstuck\GuildWars2\BuildCodes\V2\WeaponType;

function ConvertToHsArray(BuildCode $code, string $codeText)
{
	PerProfessionData::$LazyLoadMode = LazyLoadMode::FULL;
	$ingameLink = TextLoader::WriteOfficialBuildCode($code);

	$effectiveSet1 = Statics::ResolveEffectiveWeapons($code, WeaponSetNumber::Set1);
	$effectiveSet2 = Statics::ResolveEffectiveWeapons($code, WeaponSetNumber::Set2);

	//??
	$duplicateWeaponSets = $code->WeaponSet1 == $code->WeaponSet2 
		&& $code->EquipmentAttributes->WeaponSet1MainHand == $code->EquipmentAttributes->WeaponSet2MainHand;
	$oneMainOneOff = $duplicateWeaponSets && ($code->WeaponSet1->MainHand == WeaponType::_UNDEFINED 
		|| !Statics::IsTwoHanded($code->WeaponSet1->MainHand));

	$sql_data = array(
			'hs_code'            => $codeText,
			'gw2code'            => $ingameLink,
			'gamemode'           => Kind::TryGetName($code->Kind),
			'gamemode_id'        => $code->Kind,
			'profession'         => Profession::TryGetName($code->Profession),
			'profession_id'      => $code->Profession,
			'spec1_id'           => $code->Specializations->Choice1->SpecializationId,
			'spec1_name'         => SpecializationId::TryGetName($code->Specializations->Choice1->SpecializationId),
			'spec1_trait1'       => $code->Specializations->Choice1->Choices->Adept       - 1,
			'spec1_trait2'       => $code->Specializations->Choice1->Choices->Master      - 1,
			'spec1_trait3'       => $code->Specializations->Choice1->Choices->Grandmaster - 1,
			'spec2_id'           => $code->Specializations->Choice2->SpecializationId,
			'spec2_name'         => SpecializationId::TryGetName($code->Specializations->Choice2->SpecializationId),
			'spec2_trait1'       => $code->Specializations->Choice2->Choices->Adept       - 1,
			'spec2_trait2'       => $code->Specializations->Choice2->Choices->Master      - 1,
			'spec2_trait3'       => $code->Specializations->Choice2->Choices->Grandmaster - 1,
			'spec3_id'           => $code->Specializations->Choice3->SpecializationId,
			'spec3_name'         => SpecializationId::TryGetName($code->Specializations->Choice3->SpecializationId),
			'spec3_trait1'       => $code->Specializations->Choice2->Choices->Adept       - 1,
			'spec3_trait2'       => $code->Specializations->Choice2->Choices->Master      - 1,
			'spec3_trait3'       => $code->Specializations->Choice2->Choices->Grandmaster - 1,
			'heal1'              => $code->SlotSkills->Heal,
			'heal2'              => null,
			'utility1'           => $code->SlotSkills->Utility1,
			'utility2'           => $code->SlotSkills->Utility2,
			'utility3'           => $code->SlotSkills->Utility3,
			'utility4'           => $code->Profession === Profession::Revenant ? $code->ProfessionSpecific->AltUtility1 : null,
			'utility5'           => $code->Profession === Profession::Revenant ? $code->ProfessionSpecific->AltUtility2 : null,
			'utility6'           => $code->Profession === Profession::Revenant ? $code->ProfessionSpecific->AltUtility3 : null,
			'elite1'             => $code->SlotSkills->Elite,
			'elite2'             => null,
			'weapon1_s1'         => APICache::ResolveWeaponSkill($code, $effectiveSet1, 0),
			'weapon1_s2'         => APICache::ResolveWeaponSkill($code, $effectiveSet1, 1),
			'weapon1_s3'         => APICache::ResolveWeaponSkill($code, $effectiveSet1, 2),
			'weapon1_s4'         => APICache::ResolveWeaponSkill($code, $effectiveSet1, 3),
			'weapon1_s5'         => APICache::ResolveWeaponSkill($code, $effectiveSet1, 4),
			'weapon2_s1'         => APICache::ResolveWeaponSkill($code, $effectiveSet2, 0),
			'weapon2_s2'         => APICache::ResolveWeaponSkill($code, $effectiveSet2, 1),
			'weapon2_s3'         => APICache::ResolveWeaponSkill($code, $effectiveSet2, 2),
			'weapon2_s4'         => APICache::ResolveWeaponSkill($code, $effectiveSet2, 3),
			'weapon2_s5'         => APICache::ResolveWeaponSkill($code, $effectiveSet2, 4),
			'equipment_weapon1'  => $code->EquipmentAttributes->WeaponSet1MainHand,
			'equipment_weapon2'  => $code->EquipmentAttributes->WeaponSet1OffHand,
			'equipment_weapon3'  => $code->EquipmentAttributes->WeaponSet2MainHand,
			'equipment_weapon4'  => $code->EquipmentAttributes->WeaponSet2OffHand,
			'equipment_armor1'   => $code->EquipmentAttributes->Helmet,
			'equipment_armor2'   => $code->EquipmentAttributes->Shoulders,
			'equipment_armor3'   => $code->EquipmentAttributes->Chest,
			'equipment_armor4'   => $code->EquipmentAttributes->Gloves,
			'equipment_armor5'   => $code->EquipmentAttributes->Leggings,
			'equipment_armor6'   => $code->EquipmentAttributes->Boots,
			'equipment_trinket1' => $code->EquipmentAttributes->BackItem,
			'equipment_trinket2' => $code->EquipmentAttributes->Accessory1,
			'equipment_trinket3' => $code->EquipmentAttributes->Accessory2,
			'equipment_trinket4' => $code->EquipmentAttributes->Amulet,
			'equipment_trinket5' => $code->EquipmentAttributes->Ring1,
			'equipment_trinket6' => $code->EquipmentAttributes->Ring2,
			'equipment_rune1'    => $code->Rune,
			'equipment_rune2'    => $code->Rune,
			'equipment_rune3'    => $code->Rune,
			'equipment_rune4'    => $code->Rune,
			'equipment_rune5'    => $code->Rune,
			'equipment_rune6'    => $code->Rune,
			'equipment_sigil1'   => $code->WeaponSet1->Sigil1,
			'equipment_sigil2'   => $code->WeaponSet1->Sigil2,
			'equipment_sigil3'   => $code->WeaponSet2->Sigil1,
			'equipment_sigil4'   => $code->WeaponSet2->Sigil2,
			'pvp_amulet'         => $code->EquipmentAttributes->Amulet,
			'pvp_rune'           => $code->Rune,
			'weapon_type1'       => WeaponType::TryGetName($code->WeaponSet1->MainHand),
			'weapon_type2'       => WeaponType::TryGetName($code->WeaponSet1->OffHand),
			'weapon_type3'       => WeaponType::TryGetName($code->WeaponSet2->MainHand),
			'weapon_type4'       => WeaponType::TryGetName($code->WeaponSet2->OffHand),
			'weapon_id1'         => Statics::ResolveDummyItemForWeaponType($code->WeaponSet1->MainHand, $code->EquipmentAttributes->WeaponSet1MainHand),
			'weapon_id2'         => Statics::ResolveDummyItemForWeaponType($code->WeaponSet1->OffHand , $code->EquipmentAttributes->WeaponSet1OffHand ),
			'weapon_id3'         => Statics::ResolveDummyItemForWeaponType($code->WeaponSet2->MainHand, $code->EquipmentAttributes->WeaponSet2MainHand),
			'weapon_id4'         => Statics::ResolveDummyItemForWeaponType($code->WeaponSet2->OffHand , $code->EquipmentAttributes->WeaponSet2OffHand ),
			'pet1'               => $code->Profession === Profession::Ranger ? $code->ProfessionSpecific->Pet1 : null,
			'pet2'               => $code->Profession === Profession::Ranger ? $code->ProfessionSpecific->Pet1 : null,
			'legend1'            => $code->Profession === Profession::Revenant ? $code->ProfessionSpecific->Legend1 : null,
			'legend2'            => $code->Profession === Profession::Revenant ? $code->ProfessionSpecific->Legend2 : null,
			'food'               => $code->Food,
			'utility'            => $code->Utility,
			'infusions'          => transform_infusion_data($code->Infusions),
			'one_main_one_off'   => $oneMainOneOff,
			'duplicate_weapon_sets' => $duplicateWeaponSets,
	);

	global $wpdb;
	$insertion = (HS_GW2_FORCE_BUILDS_REWRITE) ? $wpdb->replace(HS_GW2_BUILDS_DB, $sql_data) : $wpdb->insert(HS_GW2_BUILDS_DB, $sql_data); 
	return ($insertion) ? $sql_data : false;
}

function transform_infusion_data(AllEquipmentInfusions $infusions) : string
{
	$arr = [];
	for($i = 0; $i < Statics::ALL_INFUSION_COUNT; $i++) {
		$itemId = $infusions[$i];
		if($itemId === ItemId::_UNDEFINED) continue;

		if(array_key_exists($itemId, $arr)) $arr[$itemId]++;
		else $arr[$itemId] = 1;
	}

	return json_encode($arr);
}

const runes_replace = array(
	'91638' => '38206',
	'91641' => '48907',
	'91513' => '24765',
	'91428' => '24732',
	'91444' => '73653',
	'91529' => '24768',
	'91392' => '67344',
	'91417' => '44951',
	'91482' => '89999',
	'91468' => '24779',
	'91564' => '24729',
	'91608' => '24703',
	'91530' => '70600',
	'91471' => '24776',
	'91566' => '24771',
	'91556' => '24708',
	'91639' => '81091',
	'91399' => '24860',
	'91550' => '44957',
	'91587' => '67342',
	'91503' => '24717',
	'91572' => '24726',
	'91411' => '49460',
	'91605' => '24857',
	'91553' => '24738',
	'91512' => '68437',
	'91401' => '24720',
	'91423' => '24714',
	'91591' => '76813',
	'91494' => '24794',
	'91576' => '24830',
	'91460' => '24687',
	'91547' => '24750',
	'91602' => '24845',
	'91477' => '24854',
	'91397' => '71425',
	'91425' => '24833',
	'91396' => '83367',
	'91599' => '24788',
	'91565' => '73399',
	'91588' => '24741',
	'91457' => '72852',
	'91483' => '82791',
	'91404' => '67912',
	'91459' => '24699',
	'91432' => '74978',
	'91430' => '70450',
	'91433' => '24723',
	'91493' => '24744',
	'91465' => '24800',
	'91522' => '24812',
	'91489' => '24747',
	'91538' => '83338',
	'91507' => '24797',
	'91408' => '24696',
	'91419' => '24851',
	'91391' => '24785',
	'91475' => '24735',
	'91570' => '24824',
	'91585' => '76100',
	'91560' => '82633',
	'91580' => '24753',
	'91435' => '24762',
	'91533' => '24688',
	'91581' => '36044',
	'91387' => '24803',
	'91568' => '84127',
	'91501' => '24842',
	'91567' => '24806',
	'91410' => '24848',
	'91497' => '24756',
	'91592' => '24702',
	'91557' => '24782',
	'91541' => '24815',
	'91578' => '70829',
	'91627' => '84171',
	'91573' => '83502',
	'91447' => '69370',
	'91595' => '24836',
	'91464' => '83663',
	'91582' => '71276',
	'91510' => '83964',
	'91590' => '84749',
	'91673' => '85713',
	'91515' => '47908',
	'91583' => '76166',
	'91579' => '24818',
	'91508' => '67339',
	'91485' => '24691',
	'91551' => '24827',
	'91445' => '24757',
	'91523' => '24821',
	'91518' => '24839',
	'91451' => '83423',
	'91593' => '24791',
	'91525' => '88118',
	'91381' => '72912',
	'91516' => '44956',
	'91545' => '24711',
);

const sigils_replace = array(
	'91589' => '72872',
	'91607' => '24618',
	'91403' => '72092',
	'91534' => '24612',
	'91520' => '24554',
	'91390' => '24601',
	'91382' => '24584',
	'91542' => '67913',
	'91604' => '24570',
	'91476' => '24575',
	'91492' => '81045',
	'91416' => '44944',
	'91546' => '24865',
	'91519' => '24645',
	'91584' => '24630',
	'91548' => '67340',
	'91473' => '72339',
	'91496' => '24578',
	'91603' => '67341',
	'91575' => '24636',
	'91431' => '24664',
	'91388' => '24583',
	'91539' => '24654',
	'91480' => '24609',
	'91544' => '70825',
	'91452' => '24681',
	'91531' => '24560',
	'91537' => '24661',
	'91441' => '24607',
	'91559' => '24548',
	'91439' => '24615',
	'91443' => '24567',
	'91461' => '82876',
	'91441' => '24607',
	'91559' => '24548',
	'91439' => '24615',
	'91443' => '24567',
	'91461' => '82876',
	'91558' => '38294',
	'91552' => '24605',
	'91455' => '24809',
	'91436' => '24648',
	'91511' => '24627',
	'91438' => '91339',
	'91406' => '24597',
	'91535' => '24555',
	'91490' => '24651',
	'91405' => '24868',
	'91463' => '67343',
	'91600' => '24678',
	'91413' => '37912',
	'91577' => '24599',
	'91502' => '24582',
	'91393' => '24591',
	'91453' => '24672',
	'91478' => '44950',
	'91543' => '68436',
	'91521' => '49457',
	'91474' => '24572',
	'91506' => '24655',
	'91398' => '24639',
	'91426' => '24580',
	'91500' => '24621',
	'91509' => '24571',
	'91420' => '24561',
	'91486' => '73532',
	'91400' => '44947',
	'91415' => '24594',
	'91429' => '71130',
	'91456' => '24658',
	'91499' => '84505',
	'91488' => '24624',
	'91609' => '24675',
	'91526' => '24684',
	'91409' => '24589',
	'91470' => '24592',
	'91561' => '24562',
	'91389' => '36053',
	'91384' => '86170',
	'91412' => '48911',
	'91448' => '74326',
	'91524' => '24642',
	'91532' => '24632',
	'91407' => '24600',
	'91594' => '24551',
	'91527' => '24667',
);